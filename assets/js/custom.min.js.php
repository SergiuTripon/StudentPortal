<?php

$files = array(

    //jQuery
    'files/jquery-latest.min.js',

    //Date Time Picker
    'files/moment.min.js',
    'files/bootstrap-datetimepicker.min.js',

    //Bootstrap
    'files/bootstrap.min.js',

    //DataTables
    'files/jquery.dataTables.min.js',
    'files/dataTables.bootstrap.min.js',

    //Google Maps
    'files/location-overview.js',
    'files/location-search.js',

    //select2
    'files/select2.min.js',

    //tileJS
    'files/tileJs.min.js',

    //Calendar
    'files/jstz.min.js',
    'files/underscore-min.js',
    'files/calendar.js',

    //Maintenance
    'files/html5shiv.min.js',
    'files/respond.min.js',
    'files/ie10-viewport-bug-workaround.js',

    //Lightbox
    'files/ekko-lightbox.min.js',

    //Custom
    'files/custom.js',
    'files/sign-out-inactive.js'

);

$modified = 0;

foreach($files as $file) {
    $age = filemtime($file);
    if($age > $modified) {
        $modified = $age;
    }
}

$offset = 60 * 60 * 24 * 7; // Cache for 1 weeks
header ('Expires: ' . gmdate ("D, d M Y H:i:s", time() + $offset) . ' GMT');

if (isset($_SERVER['HTTP_IF_MODIFIED_SINCE']) && strtotime($_SERVER['HTTP_IF_MODIFIED_SINCE']) >= $modified) {
    header("HTTP/1.0 304 Not Modified");
    header ('Cache-Control:');
} else {
    header ('Cache-Control: max-age=' . $offset);
    header ('Content-type: text/javascript; charset=UTF-8');
    header ('Pragma:');
    header ("Last-Modified: ".gmdate("D, d M Y H:i:s", $modified )." GMT");

    function compress($buffer) {
        /* remove comments */
        $buffer = preg_replace("/((?:\/\*(?:[^*]|(?:\*+[^*\/]))*\*+\/)|(?:\/\/.*))/", "", $buffer);
        /* remove tabs, spaces, newlines, etc. */
        $buffer = str_replace(array("\r\n","\r","\t","\n",'  ','    ','     '), '', $buffer);
        /* remove other spaces before/after ) */
        $buffer = preg_replace(array('(( )+\))','(\)( )+)'), ')', $buffer);
        return $buffer;
    }

    ob_start('ob_gzhandler');

    foreach($files as $file) {
        if(strpos(basename($file),'.min.')===false) { //compress files that aren't minified
            ob_start("compress");
            include($file);
            ob_end_flush();
        } else {
            include($file);
        }
    }

    ob_end_flush();
}